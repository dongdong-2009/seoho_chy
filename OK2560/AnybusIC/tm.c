/*******************************************************************************
********************************************************************************
**
** File Name
** ---------
**
** TM.C
**
********************************************************************************
********************************************************************************
**
** Description
** -----------
** This file contains timer routines used to determin modbus timouts.
** - 3.5 char timout ( end of message )
** - Response timout ( no response )
**
**
********************************************************************************
********************************************************************************
**                                                                            **
** COPYRIGHT NOTIFICATION (c) 1995,96,97,98,99 HMS Industrial Networks AB.    **
**                                                                            **
** This program is the property of HMS Industrial Networks AB.                **
** It may not be reproduced, distributed, or used without permission          **
** of an authorised company official.                                         **
**                                                                            **
********************************************************************************
********************************************************************************
**
** Company: HMS Industrial Networks AB
**          Pilefeltsgatan 93-95
**          S-302 50  Halmstad
**          SWEDEN
**          Tel:     +46 (0)35 - 17 29 00
**          Fax:     +46 (0)35 - 17 29 09
**          e-mail:  info@hms.se
**
********************************************************************************
********************************************************************************
*/

/*******************************************************************************
********************************************************************************
**
** Change Log
** ----------
**
** Latest Revision:
**
**    Rev 0.10    12 jun 2002   Created by AnN
**    Rev 1.00    12 jul 2002   First Release
**
********************************************************************************
********************************************************************************
*/

#include "include.h"


/*******************************************************************************
**
** Public Globals
**
********************************************************************************
*/

UINT16 TM_iResponseTime;
UINT16 TM_iTimeOutTime;


/*******************************************************************************
**
** Public Services
**
********************************************************************************
*/

/*------------------------------------------------------------------------------
** TM_StartTimer()
**------------------------------------------------------------------------------
*/

void TM_StartTimer()
{

   /*
   ** Timer 1 start
   */

	TCCR1A = 0x00;
	TCCR1B = 0x0C;
	TCCR1C = 0x00;
	TCNT1 = 0x0000;
	OCR1A= 62499;//waiting

	TIMSK1 = 0x00;
	TIFR1= 0x2F;
	

   

   TM_iResponseTime = 0;

}/* end TM_StartTimer */


/*------------------------------------------------------------------------------
** TM_SetTimer()
**------------------------------------------------------------------------------
*/

void TM_SetTimer( UINT16 iTime )
{

   /*
   ** If this is the first SetTimer since starttimer we should calculate
   ** the response time.
   */

   if( TM_iResponseTime == 0 )
   {

      TM_iResponseTime = TCNT1;

   }/* end if */

   TM_iTimeOutTime = iTime;


   /*
   ** Set new timout time
   */

	OCR1A= iTime;//waiting

   /*TH0=0xD8;    /* 10 ms: FFFF-D8EF=2710 (dec.10000) */
   /*TL0=0xEF;*/



}/* end TM_SetTimer */


/*------------------------------------------------------------------------------
** TM_SetTimer()
**------------------------------------------------------------------------------
*/

void TM_StopTimer()
{
   if( TM_iResponseTime == 0 )
   {

      TM_iResponseTime = TCNT1;

   }/* end if */

}/* end TM_StopTimer */


/*------------------------------------------------------------------------------
** TM_TimeOut()
**------------------------------------------------------------------------------
*/

BOOL TM_TimeOut()
{

   /*
   ** Wait for response
   */

   if( TIFR1 & 0x02 )
   {

      /*
      ** Timer 1 stop
      */

      TIFR1= 0x2F;
      return( TRUE );

   }
   else
   {

      return( FALSE );

   }/* end if timer timed out */

}/* end TM_TimeOut */


/*******************************************************************************
**
** End of TM.C
**
********************************************************************************
*/